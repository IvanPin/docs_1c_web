## API интеграции пользователя Сайт ↔ 1С

Цель: единый метод синхронизации данных пользователя между сайтом (1C‑Битрикс) и 1С.

- **Один метод**: в зависимости от состава полей запроса выполняет поиск/регистрацию/обновление.
- **Идентификатор пользователя**: номер телефона в формате `+7XXXXXXXXXX`.
- **Единый формат ответа** 1С: `{ "status": 1|0, "error": string|null, "result": object|null }`.
- **Безопасность**: заголовок `ApiKey`.


### Эндпоинт

- **URL (пример)**: `POST https://<1c-host>/api/v1/user/sync`
- **Метод**: `POST`
- **Заголовки**:
  - `Content-Type: application/json; charset=utf-8`
  - `ApiKey: <секретный_ключ>` (например, `b248000c29f889b211ee5072583e1e2e` — тестовый)

### Поведение

1. **Авторизация/Регистрация на сайте**: сайт отправляет только телефон. 1С:
   - если пользователь существует — возвращает полные данные;
   - если не существует — регистрирует и возвращает полные данные.
2. **Редактирование на сайте**: сайт отправляет полный профиль. 1С:
   - выполняет upsert (обновление/создание) и возвращает полные данные.

Правило выбора операции:
- Если в `user` передан только `phone` → режим «поиск/регистрация по телефону».
- Если в `user` переданы дополнительные поля → режим «upsert по телефону».

### Схемы JSON

Запрос:

```json
{
  "user": {
    "phone": "+79991234567",
    "email": "user@example.com",
    "lastName": "Иванов",
    "firstName": "Иван",
    "middleName": "Иванович",
    "birthday": "1990-01-31",
    "gender": "M",
    "externalId": "123" 
  }
}
```

Пояснения к полям `user`:
- `phone` (string, required): формат `+7` и 11 цифр. Ключ.
- `email` (string, optional): валидный e-mail.
- `lastName` (string, optional): фамилия.
- `firstName` (string, optional): имя.
- `middleName` (string, optional): отчество.
- `birthday` (string, optional): `YYYY-MM-DD`.
- `gender` (string, optional): `M` | `F` | `U` (неизвестно).
- `externalId` (string, optional): внутренний ID сайта (например, Bitrix `ID`). Не ключ в 1С, передаётся как справочная ссылка.

Ответ 1С (единый формат):

```json
{
  "status": 1,
  "error": null,
  "result": {
    "user": {
      "oneCId": "8d4e5a86-...",
      "phone": "+79991234567",
      "email": "user@example.com",
      "lastName": "Иванов",
      "firstName": "Иван",
      "middleName": "Иванович",
      "birthday": "1990-01-31",
      "gender": "M",
      "loyalty": {
        "cardsCount": 2,
        "bonusBalance": 3500
      }
    }
  }
}
```

При ошибке:

```json
{
  "status": 0,
  "error": "Пользователь не найден и авто‑регистрация отключена",
  "result": null
}
```

Замечания:
- Поле `result` — объект для данного метода. `status=0` → `result=null`.
- Объект `loyalty` содержит агрегаты (кол-во карт, текущий баланс бонусов). Детальная история и крупные выборки должны запрашиваться отдельными методами с пагинацией.

### Примеры

1) Авторизация/регистрация (только телефон):

Запрос:

```http
POST /api/v1/user/sync HTTP/1.1
Host: <1c-host>
Content-Type: application/json
ApiKey: b248000c29f889b211ee5072583e1e2e

{
  "user": { "phone": "+79991234567" }
}
```

Успешный ответ:

```json
{
  "status": 1,
  "error": null,
  "result": {
    "user": {
      "oneCId": "8d4e5a86-...",
      "phone": "+79991234567",
      "email": "user@example.com",
      "lastName": "Иванов",
      "firstName": "Иван",
      "middleName": "Иванович",
      "birthday": "1990-01-31",
      "gender": "M",
      "loyalty": { "cardsCount": 2, "bonusBalance": 3500 }
    }
  }
}
```

2) Редактирование профиля (полный объект):

Запрос:

```http
POST /api/v1/user/sync HTTP/1.1
Host: <1c-host>
Content-Type: application/json
ApiKey: b248000c29f889b211ee5072583e1e2e

{
  "user": {
    "phone": "+79991234567",
    "email": "new@example.com",
    "lastName": "Иванов",
    "firstName": "Иван",
    "birthday": "1991-02-15",
    "gender": "M",
    "externalId": "123"
  }
}
```

Ответ:

```json
{
  "status": 1,
  "error": null,
  "result": {
    "user": {
      "oneCId": "8d4e5a86-...",
      "phone": "+79991234567",
      "email": "new@example.com",
      "lastName": "Иванов",
      "firstName": "Иван",
      "birthday": "1991-02-15",
      "gender": "M",
      "loyalty": { "cardsCount": 2, "bonusBalance": 3500 }
    }
  }
}
```

### Валидация и нормализация

- Телефон нормализуется к `+7XXXXXXXXXX`. Допустимы входы вида `8XXXXXXXXXX` — конвертировать в `+7`.
- При отсутствии пользователя и включённой авто‑регистрации — создавать запись.
- `birthday` должен соответствовать `YYYY-MM-DD`; иначе игнорировать поле и вернуть предупреждение в `error` или детальный массив ошибок в будущем `warnings`.

### Ошибки и коды

Единый признак ошибки — `status=0` и текст в `error`.

Рекомендуемые тексты:
- `Неверный ApiKey`
- `Неверный формат телефона`
- `Внутренняя ошибка сервиса 1С`
- `Пользователь не найден и авто‑регистрация отключена`

HTTP-коды (рекомендуется):
- `200` — бизнес‑успех (`status` может быть `1` или `0`, т.к. бизнес‑ошибка возвращается в теле);
- `401` — ошибка авторизации (неверный `ApiKey`);
- `429` — лимит запросов превышен;
- `500` — техническая ошибка сервера 1С.

### Безопасность

- Обязателен заголовок `ApiKey`. Ключ вращать и хранить в секретах окружения.


### Лояльность и большие данные

- В `result.user.loyalty` возвращаем только агрегаты (`cardsCount`, `bonusBalance`).
- История покупок, начислений/списаний баллов и крупные выборки карт — отдельные методы с пагинацией.


### Соответствие полям Битрикс

- `LOGIN` ↔ `phone`
- `EMAIL` ↔ `email`
- `LAST_NAME` ↔ `lastName`
- `NAME` ↔ `firstName`
- `SECOND_NAME` ↔ `middleName`
- `PERSONAL_BIRTHDAY` ↔ `birthday`
- `PERSONAL_GENDER` ↔ `gender`
- `ID` (Bitrix) ↔ `externalId` (передаётся информативно)

