## Обмен заказами (Сайт ↔ 1С)

Назначение: двусторонняя синхронизация заказов между сайтом и 1С. Сайт предоставляет выборку заказов для обработки в 1С и принимает обратные обновления по статуса, оплате, составу и произвольным свойствам.

## Получение заказов (Сайт → 1С)

- **Метод**: `POST`
- **Путь**: `/api/1c/orders.php`
- **Заголовки**:
  - `Content-Type: application/json; charset=utf-8`
  - `ApiKey: <секретный_ключ>` (если включена проверка ключа для обмена)

### Формат запроса

В теле передаются фильтры. Все поля опциональны, отсутствие поля трактуется как «не фильтровать».

```json
{
  "userIdentifier": "1",
  "is_synced": "N",
  "id": 79
}
```

| Поле | Тип | Описание |
| --- | --- | --- |
| `userIdentifier` | string | Идентификатор пользователя на сайте. |
| `is_synced` | string | Признак выгрузки в 1С: `N` — не синхронизирован, `Y` — уже выгружен. **Игнорируется, если передан параметр `id`.** |
| `id` | integer | Внутренний ID заказа на сайте. Если указан, параметр `is_synced` игнорируется. |

По умолчанию рекомендуется запрашивать заказы с `is_synced = "N"`, обрабатывать их в 1С и затем помечать как синхронизированные (см. метод обновления).

**Важно:** При передаче параметра `id` параметр `is_synced` полностью игнорируется, и возвращается заказ с указанным ID независимо от его статуса синхронизации.

### Ответ

```json
{
  "orders": [
    {
      "id": "51",
      "status": "Ожидает оплаты",
      "status_id": "N",
      "price": 0,
      "deliveryPrice": 0,
      "createdOn": "01.11.2024 14:34:53",
      "updatedOn": "01.11.2024 14:34:53",
      "customer_card": "79083029777",
      "properties": [
        {
          "name": "ФИО",
          "value": "Иванов Иван",
          "code": "FIO"
        }
      ],
      "items": [
        {
          "id": "106",
          "xml_id": "9f176fa6-939f-11ef-8fb8-00155d000e07",
          "name": "Шуба Эко-мех",
          "price": 9990,
          "quantity": 1,
          "discount": 0,
          "subtotal": 9990
        }
      ],
      "deliveryDetails": {
        "title": "Самовывоз",
        "id": 5
      },
      "paymentDetails": {
        "title": "Картой на сайте",
        "id": 0,
        "paid": false
      }
    }
  ]
}
```

#### Поля заказа

- `id` (string) — идентификатор заказа на сайте (обязательное поле).
- `status` (string) — локализованный статус заказа.
- `status_id` (string) — код статуса заказа (см. справочник ниже).
- `price` (number) — сумма заказа без доставки.
- `deliveryPrice` (number) — стоимость доставки.
- `createdOn` (string) — дата создания заказа (`DD.MM.YYYY HH:mm:ss`).
- `updatedOn` (string) — дата последнего обновления заказа (`DD.MM.YYYY HH:mm:ss`).
- `customer_card` (string, optional) — номер телефона клиента.
- `is_synced` (string, optional) — признак передачи в 1С (`Y` | `N`), если возвращается.
- `comment` (string|null, optional) — комментарий менеджера/клиента.
- `properties` (array) — произвольные свойства заказа.
  - `name` (string) — отображаемое название свойства.
  - `value` (string) — значение.
  - `code` (string) — символьный код (см. справочник ниже).
- `items` (array) — позиции заказа.
  - `id` (string) — ID товара/торгового предложения на сайте.
  - `xml_id` (string) — внешний код (GUID) товара/предложения.
  - `name` (string) — название позиции.
  - `price` (number) — цена за единицу.
  - `quantity` (number) — количество.
  - `discount` (number) — скидка по позиции.
  - `subtotal` (number) — сумма по позиции с учётом скидки.
- `deliveryDetails` (object) — информация о доставке.
  - `title` (string) — название службы доставки.
  - `id` (integer|string) — идентификатор доставки.
- `paymentDetails` (object) — информация об оплате.
  - `title` (string) — название способа оплаты.
  - `id` (integer|string) — идентификатор способа.
  - `paid` (boolean) — факт оплаты.

## Обновление заказов (1С → Сайт)

- **Метод**: `POST`
- **Путь**: `/api/1c/orders/update.php`
- **Заголовки**:
  - `Content-Type: application/json; charset=utf-8`
  - `ApiKey: <секретный_ключ>`

Метод предназначен для обратной синхронизации после обработки заказа в 1С: подтверждение оплаты, смена статуса, передача фактических позиций, добавление служебных свойств.

### Формат запроса

```json
{
  "orders": [
    {
      "id": "51",
      "status_id": "P",
      "comment": "Оплачен в 1С, передан на склад",
      "is_synced": "Y",
      "paymentDetails": {
        "paid": true,
        "title": "Оплата в 1С",
        "id": 3
      },
      "properties": [
        {
          "code": "TRACK_NUMBER",
          "value": "SDEK1234567890"
        }
      ],
      "items": [
        {
          "id": "106",
          "quantity": 1,
          "price": 9990,
          "discount": 0,
          "subtotal": 9990,
          "status": "Отгружен со склада"
        }
      ]
    }
  ]
}
```

| Поле | Тип | Описание |
| --- | --- | --- |
| `orders` | array | Список заказов для обновления (обязательное поле). |
| `orders[].id` | string | Идентификатор заказа на сайте. |
| `orders[].status_id` | string | Новый код статуса (из справочника). |
| `orders[].comment` | string | Служебный комментарий от 1С. |
| `orders[].is_synced` | string | Для подтверждения завершения обработки (`Y`|`N`). |
| `orders[].paymentDetails` | object | Параметры способа оплаты и факт оплаты. |
| `orders[].properties` | array | Массив свойств; `code` обязателен, `name` может не передаваться. |
| `orders[].items` | array | Обновлённые позиции заказа (если 1С скорректировала состав или статус). |

### Ответ

```json
{
  "status": 1,
  "error": null,
  "result": {
    "processed": [
      {
        "id": "51",
        "status": "P",
        "updatedOn": "01.11.2024 16:01:12"
      }
    ]
  }
}
```

- `status = 1` — все обновления применены.
- `status = 0` — одна или несколько записей не обработаны; подробности в `error` или `result.failed`.

Пример расширенного ответа:

```json
{
  "status": 0,
  "error": "Некоторые заказы не найдены",
  "result": {
    "processed": [
      { "id": "51" }
    ],
    "failed": [
      {
        "id": "999",
        "error": "Заказ не найден"
      }
    ]
  }
}
```

## Справочники

### Свойства заказа (`properties.code`)

| Название | Код |
| --- | --- |
| Местоположение | `LOCATION` |
| ФИО | `FIO` |
| E-mail | `EMAIL` |
| Телефон | `PHONE` |
| Адрес доставки | `ADDRESS` |

При необходимости можно расширять список дополнительными кодами (например, `TRACK_NUMBER`, `COMMENT_1C`). Коды должны быть согласованы между системами.

### Типы доставок

| Название | Код |
| --- | --- |
| Самовывоз | `6` |
| СДЭК (Самовывоз) | `sdek:pickup` |
| СДЭК (Постамат) | `sdek:postamat` |
| СДЭК (Доставка курьером) | `sdek:courier` |

### Статусы заказов

| Название | Код |
| --- | --- |
| Выполнен | `F` |
| Отменен | `O` |
| Доставлен/Получен | `A` |
| В сборке | `S` |
| Возврат выполнен | `H` |
| Оплачен | `P` |
| Готов к выдаче | `D` |
| Проблема с заказом | `E` |
| Возврат в процессе | `V` |
| Ожидает оплаты | `N` |
| В пути | `R` |

## Рекомендации по процессу

- После успешной обработки заказа в 1С вызывайте метод обновления с `is_synced = "Y"`, чтобы исключить повторную выгрузку.
- При необходимости частичного обновления (только статус или оплата) допустимо передавать только изменённые поля (`id` + целевой блок).
- Старайтесь логировать идентификаторы заказов и ответы сервиса, чтобы упростить расследование при расхождениях.
