### Сервис расчета скидок (1С → сайт)

Назначение: единая точка расчета скидок и бонусов на стороне 1С. Сайт передает состав чека и параметры покупателя одним запросом и получает итоговые суммы и метаданные по примененным акциям.

## Эндпоинт

- Метод: POST
- Путь: `/api/v1/discounts/calc`
- Тело: JSON (`application/json; charset=utf-8`)

Аутентификация/авторизация описывается отдельно (в рамках интеграции между сайтом и 1С).

## Формат запроса

Общие принципы:
- Все позиции, выбранные к покупке, передаются одним массивом как «единый чек» (так работает расчет в 1С).
- Идентификатор товара — GUID 1С. Код номенклатуры (`id`) можно передавать дополнительно, но для расчета используется `guid`.
- Размер для ювелирных позиций — строка в формате 1С. В JSON необходимо экранировать обратный слеш.

Структура:

```json
{
  "store_id": "f8bbf47e-1777-11ea-a69d-00155d006111",
  "customer_card": "79083029777",
  "loyalty_redeem_points": 15000,
  "coupon": "SUMMER2024",
  "goods": [
    {
      "guid": "f186e4f4-3eb1-11eb-b207-005056a3a084",
      "id": "ФМ-00014222",
      "size": "17.0\\19.0",
      "count": 1,
      "description": "Браслет декоративный из золота 585 с бриллиантами"
    },
    {
      "guid": "568dab27-b75f-11e9-83f2-00155d003a06",
      "id": "ФМ-00014427",
      "size": "40.0",
      "count": 2,
      "description": "Цепь полновесная из золота 585 без вставки"
    }
  ]
}
```

Поля запроса:
- `store_id` (string, required): GUID магазина/склада 1С.
- `customer_card` (string, optional): логин/номер карты лояльности. Пустая строка, если без карты.
- `loyalty_redeem_points` (integer, optional, default 0): сколько бонусных баллов пользователь хочет списать на чек. Фактическое распределение по позициям выполняет 1С.
- `coupon` (string, optional): код купона, введенный пользователем. Передается один купон. Если купон не указан или пустая строка, расчет выполняется без учета купона.
- `goods` (array, required): список позиций чека.
  - `guid` (string, required): GUID номенклатуры 1С.
  - `id` (string, optional): код номенклатуры в 1С.
  - `size` (string, optional/required по типу товара): размер, как в 1С (например, `"17.0\\21.5"`).
  - `count` (integer, required): количество (> 0).
  - `description` (string, optional): наименование/описание (для удобства отладки; в расчете не участвует).

Примечания:
- Виды цен типа «retail/wholesale» не передаются: актуальная цена определяется внутри 1С автоматически.
- Базовую цену (`base_price`) сайт в запросе не передает.
- Купон передается как код (строка). Валидация и применение купона выполняется на стороне 1С. Если купон недействителен, истек или не применим к текущему составу чека, он не применяется, но ошибка не возвращается — информация об этом отражается в ответе (см. поле `coupon_applied`).

## Формат ответа

```json
{
  "store_id": "f8bbf47e-1777-11ea-a69d-00155d006111",
  "customer_card": "79083029777",
  "loyalty_redeem_points": 15000,
  "coupon": "SUMMER2024",
  "coupon_applied": true,
  "totals": {
    "base_sum": 0,
    "discount_sum": 0,
    "sum": 0,
    "sum_points": 0
  },
  "goods": [
    {
      "id": "ФМ-00014222",
      "guid": "f186e4f4-3eb1-11eb-b207-005056a3a084",
      "count": 1,
      "base_price": 470000,
      "sum": 211500,
      "discount_name": "Бриллианты 55%; Бонус: 5%, бонусная программа Бонусная; Купон SUMMER2024: -10%",
      "sum_points": 10575,
      "loyalty_redeem_points": 15000
    },
    {
      "id": "ФМ-00014427",
      "guid": "568dab27-b75f-11e9-83f2-00155d003a06",
      "count": 2,
      "base_price": 29490,
      "sum": 26541,
      "discount_name": "Полудраги 55%; Бонус: 5%, бонусная программа Бонусная; Купон SUMMER2024: -10%",
      "sum_points": 1327.05,
      "loyalty_redeem_points": 0
    }
  ]
}
```

Поля ответа:
- Дублируются входные `store_id`, `customer_card`, `loyalty_redeem_points`, `coupon` (как запрошено, до распределения по позициям).
- `coupon_applied` (boolean): признак применения купона. `true` — купон был передан в запросе и успешно применен к расчету; `false` — купон не был передан, недействителен, истек, не применим к текущему составу чека или не может быть использован по другим причинам. Если купон не был передан в запросе, значение `false`.
- `totals` (object): итоговые суммы по чеку, агрегированные по всем позициям (см. единицы измерения ниже). Значения могут быть 0, если система не возвращает агрегаты — в этом случае клиенту следует агрегировать по массиву `goods`.
- `goods[]`:
  - `id` (string): код номенклатуры 1С.
  - `guid` (string): GUID номенклатуры 1С.
  - `count` (integer): количество из запроса.
  - `base_price` (integer): базовая цена за единицу до скидок в минимальных денежных единицах (копейках).
  - `sum` (integer): сумма по позиции после всех скидок (включая купон, если применен) и списаний в копейках (за все количество позиции).
  - `discount_name` (string): человекочитаемое описание примененных акций/скидок. Если купон применен, информация о нем включается в описание (например, "Купон SUMMER2024: -10%").
  - `sum_points` (number): начисленные бонусные баллы по позиции (допускается дробная часть, точность 2 знака).
  - `loyalty_redeem_points` (integer): сколько бонусных баллов фактически списано по данной позиции (распределено 1С).

## Единицы измерения и округление

- Денежные суммы и цены: целые числа в минимальных денежных единицах (копейках). Например, 294.90 ₽ → `29490`.
- Бонусные баллы: десятичное число с точностью до 2 знаков (например, `1327.05`).
- Округление цен/сумм выполняется на стороне 1С по правилам 1С; при разнице из‑за распределения «копеек» при помпозиционном округлении значимыми считаются значения из ответа (`sum` по позиции и агрегированные суммы, если присутствуют). 
- Распределение списываемых баллов (`loyalty_redeem_points`) по позициям выполняет 1С. Клиенту не требуется делить баллы самостоятельно.

## Поведение и ограничения

- Рассчитывать скидки следует всегда на полном составе чека. Для пересчета (изменение количества, добавление/удаление товара, изменение карты/баллов/купона) — вызывать API повторно.
- Если товар требует указания размера, передавайте `size` ровно в формате 1С (в JSON экранировать `\\`).
- Если позиция в 1С не найдена или недоступна к продаже из указанного `store_id`, будет возвращена ошибка (см. ниже).
- Купон передается один на весь чек. Если купон недействителен или не применим, расчет выполняется без учета купона, в ответе `coupon_applied` будет `false`. Ошибка не возвращается, чтобы не блокировать расчет скидок по другим правилам.

## Примеры

Минимальный запрос (без карты, списания баллов и купона):

```json
{
  "store_id": "f8bbf47e-1777-11ea-a69d-00155d006111",
  "goods": [
    { "guid": "f186e4f4-3eb1-11eb-b207-005056a3a084", "count": 1 },
    { "guid": "568dab27-b75f-11e9-83f2-00155d003a06", "count": 2 }
  ]
}
```

Запрос с купоном:

```json
{
  "store_id": "f8bbf47e-1777-11ea-a69d-00155d006111",
  "coupon": "WINTER2024",
  "goods": [
    { "guid": "f186e4f4-3eb1-11eb-b207-005056a3a084", "count": 1 },
    { "guid": "568dab27-b75f-11e9-83f2-00155d003a06", "count": 2 }
  ]
}
```

Рабочий пример запроса и ответа см. выше в разделах «Формат запроса/ответа».

## Ошибки

HTTP‑статусы:
- 400 Bad Request — ошибка валидации входных данных.
- 404 Not Found — не найден `store_id` или номенклатура/размер.
- 422 Unprocessable Entity — бизнес‑ограничения (недостаточно баллов, недоступен товар, несовместимые акции и т.п.).
- 500 Internal Server Error — внутренняя ошибка сервиса расчета.
- 503 Service Unavailable — временная недоступность 1С или зависимых сервисов.

Формат тела ошибки:

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Поле goods[0].guid обязательно",
    "details": [
      { "field": "goods[0].guid", "message": "required" }
    ],
    "trace_id": "8b6b2b1a-2a9a-4a0b-9f6f-0e6e8c6d9f1c"
  }
}
```

Пример бизнес‑ошибки (недостаточно баллов для списания):

```json
{
  "error": {
    "code": "INSUFFICIENT_POINTS",
    "message": "Недостаточно баллов для списания",
    "details": [{ "requested": 15000, "available": 12000 }],
    "trace_id": "5c2e3f0d-7a6b-4a6e-9d8c-1fa0e5f5a9b2"
  }
}
```

## Версионирование

- Рекомендуется версионировать путь (`/api/v1/discounts/calc`). Изменения, ломающие обратную совместимость, публиковать под новым префиксом (`v2`).

## Идемпотентность

- Запрос является детерминированным по входным данным. При повторных вызовах с одинаковым телом ответа совпадают (за исключением транзитных факторов, например, изменения настроек скидок в 1С между вызовами).

## Замечания по внедрению на сайте

- В корзине и на чекауте всегда вызывать расчет после изменений состава/количеств/карты/баллов.
- Для отображения состава скидок использовать `discount_name`. Для подсчетов использовать числа из ответа: `sum` по позициям либо агрегат `totals.sum`.
- Если сайт хранит цены локально, не использовать их для расчета. Актуальная базовая цена приходит из 1С в `base_price`.


