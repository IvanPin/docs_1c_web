## Обновление информации о товарах и торговых предложениях (1С → сайт)

Назначение: публикация событий обновления каталога из 1С. Сообщение помещается в обменник и далее обрабатывается сайтом.

### Эндпоинт

- **Метод**: `POST`
- **Путь**: `/api/exchanges/%2F/1C-Catalog/publish`
- **Тело**: JSON (`application/json; charset=utf-8`)

### Формат запроса

Тело запроса — JSON-объект, содержащий массив `products` и, при необходимости, метаданные пакета `batch`.

Пример запроса

```json
{
  "batch": {
    "id": "1c-catalog-2026-02-18T10:15:00Z",
    "seq": 3,
    "total": 10,
    "is_last": false
  },
  "products": [
    {
      "product": {
        "external_code": "PRODUCT001123",
        "name": "Тест товар 1С 1",
        "properties": {
          "CATEGORY": "Смартфоны",
          "BREND": "Apple",
          "ART": "123123",
          "url_detail_img": [
            "\\\\srv-1cbuh-nn.kokonn.local\\pic_unf\\20221029\\AR3344BKZ,WFM\\/B.jpg"
          ]
        },
        "quantity": 100,
        "store_quantities": [
          {
            "store_id": "d0744917-1777-11ea-a69d-00155d006111",
            "quantity": 564
          },
          {
            "store_id": "d0744917-1777-11ea-a69d-00155d006112",
            "quantity": 210
          }
        ],
        "price": 432,
        "discount_price": 123
      }
    },
    {
      "product": {
        "external_code": "PRODUCT002123",
        "name": "Второй Тест товар 1С 1",
        "properties": {
          "CATEGORY": "Смартфоны",
          "BREND": "Apple",
          "ART": "123123"
        }
      },
      "offers": [
        {
          "external_code": "OFFER001_2123",
          "name": "Второй Тест товар 1С 1",
          "properties": {
            "CATEGORY": "Смартфоны",
            "BREND": "Apple",
            "ART": "123123",
            "url_detail_img": [
              "\\\\srv-1cbuh-nn.kokonn.local\\pic_unf\\20221029\\AR3344BKZ,WFM\\/B.jpg"
            ]
          },
          "quantity": 100,
          "store_quantities": [
            {
              "store_id": "d0744917-1777-11ea-a69d-00155d006111",
              "quantity": 564
            },
            {
              "store_id": "d0744917-1777-11ea-a69d-00155d006112",
              "quantity": 210
            }
          ],
          "price": 432,
          "discount_price": 123,
          "price_with_max_bonus": 100
        }
      ]
    }
  ]
}
```

Пример запроса (последний пакет)

```json
{
  "batch": {
    "id": "1c-catalog-2026-02-18T10:15:00Z",
    "seq": 10,
    "total": 10,
    "is_last": true
  },
  "products": [
    {
      "product": {
        "external_code": "PRODUCT002123",
        "name": "Второй Тест товар 1С 1"
      }
    }
  ]
}
```

### Пояснения к полям

- `batch` (object, optional): метаданные пакета выгрузки.
  - `id` (string, optional): идентификатор выгрузки (одинаковый для всех пакетов одной выгрузки).
  - `seq` (integer, optional): номер пакета (начиная с `1`).
  - `total` (integer, optional): общее число пакетов в выгрузке.
  - `is_last` (boolean, optional): признак, что текущий пакет — последний. Если `true`, сайт должен считать выгрузку завершённой и выполнить финальные операции.

- `products` (array): список продуктов. Каждый элемент содержит информацию о продукте и, при наличии, список его торговых предложений.

- `product` (object): основная информация о конкретном продукте.
  - `external_code` (string): внешний код продукта (GUID/ID из 1С или иная уникальная ссылка).
  - `name` (string, optional): наименование продукта.
  - `properties` (object, optional): произвольные атрибуты продукта в формате ключ/значение. Поддерживается, в частности, ключ `url_detail_img` — массив путей или URL к фотографиям товара (например `"\\\\srv-1cbuh-nn.kokonn.local\\pic_unf\\20221029\\AR3344BKZ,WFM/B.jpg"`).
  - `quantity` (integer, optional): суммарное количество по всем складам.
  - `store_quantities` (array, optional): список объектов, описывающих остатки по складам.
    - `store_id` (string): идентификатор склада (GUID, код и т.п.).
    - `quantity` (number): остаток на соответствующем складе.
  - `price` (number, optional): цена без скидки.
  - `discount_price` (number, optional): цена со скидкой.
  - `price_with_max_bonus` (number, optional): Цена с учётом максимальных бонусов.

- `offers` (array, optional): список предложений (SKU) для продукта.
  - Каждый элемент — объект с полями предложения:
    - `external_code` (string): внешний код предложения.
    - `name` (string, optional): наименование предложения.
    - `properties` (object, optional): свойства предложения. Аналогично продукту, может содержать ключ `url_detail_img` со списком путей/URL к фотографиям. Старайтесь не дублировать характеристики, которые уже присутствуют у продукта; в предложении имеет смысл передавать только уникальные атрибуты, специфичные для данного SKU (например, размер кольца).
    - `quantity` (integer, optional): суммарное количество предложения на складах.
    - `store_quantities` (array, optional): аналогично продукту — массив объектов с полями `store_id` и `quantity`.
    - `price` (number, optional): цена предложения без скидки.
    - `discount_price` (number, optional): цена предложения со скидкой.

### Замечания

- Рекомендуемый режим для пакетной выгрузки: передавать `batch.id` одинаковым для всех пакетов, а в последнем пакете выставлять `batch.is_last=true`.
- Если `batch.is_last=true`, сайт должен:
  - пометить выгрузку `batch.id` как завершённую;
  - запустить пост-обработку (например, пересчёт поискового индекса, очистка кешей, финальные проверки, перевод статуса обмена в `done`).
- Если `batch.id` не передан, обработчик может работать в режиме обратной совместимости: не выполнять финальные шаги автоматически, либо выполнять их только при `is_last=true`.
- Минимальная валидация `batch`:
  - `is_last` должен быть boolean;
  - если указан `total`, то `seq` должен быть меньше или равен `total`;
  - если `is_last=true` и указан `total`, рекомендуется требовать `seq == total`.
- Идентификаторы складов (например, `mgkl100321` или GUID) передаются в поле `store_id` элементов массива `store_quantities`.
- Если для продукта указаны `offers`, все значения по ценам, суммарным остаткам и остаткам по складам должны передаваться в рамках каждого конкретного предложения. Поля `price`, `discount_price`, `quantity` и `store_quantities` на уровне `product` в этом случае могут служить только общими значениями по умолчанию или метаданными (по согласованию с потребителем).
- Если у продукта нет `offers`, то данные по `price`, `discount_price`, `quantity` и `store_quantities` заполняются на уровне `product`.
